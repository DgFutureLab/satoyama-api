# box: wercker/python
# services: 
# 	- wercker/postgresql
# build:
# 	steps:
# 		- pip-install
# 		- script:
# 			name: webapp tests
# 			code: py.test -v
box: wercker/python
# Build definition
services:
  - wercker/postgresql
build:
  # The steps that will be executed on build
  steps:
    - add-to-known_hosts:
        hostname: $DIGITALOCEAN_TEKRICE_URL
    # A step that sets up the python virtual environment
    - virtualenv:
        name: setup virtual environment
        install_wheel: true # Enable wheel to speed up builds (experimental)

    # # Use this virtualenv step for python 3.2
    # - virtualenv
    #     name: setup virtual environment
    #     python_location: /usr/bin/python3.2

    # A step that executes `pip install` command.
    - pip-install

    # # This pip-install clears the local wheel cache
    # - pip-install:
    #     clean_wheel_dir: true

    # A custom script step, name value is used in the UI
    # and the code value contains the command that get executed
    - script:
        name: echo python information
        code: |
          echo "python version $(python --version) running"
          echo "pip version $(pip --version) running"
    - script:
        name: start test webserver
        code: python run_webserver.py --env test
    - script:
        name: API tests
        code: py.test -v
    - script:
        name: transfer application
        code: |
          pwd
          ls -la
          scp -i $PRIVATEKEY_PATH -o StrictHostKeyChecking=no -o UserKnownHostsFile=no foo-test $DIGITALOCEAN_TEKRICE_USER@$DIGITALOCEAN_TEKRICE_URL:/home/halfdan/satoyama-api